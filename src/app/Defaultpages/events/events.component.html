<div class="events-container">
  <h1 class="text-center mb-4">All Upcoming Events</h1>

  <div *ngIf="loading" class="loading text-center">
    <p>Loading events...</p>
  </div>

  <div *ngIf="error" class="alert alert-danger text-center">
    {{ error }}
  </div>

  <!-- Search, Filter & Add Event -->
  <div
    class="filters mb-3 d-flex align-items-center justify-content-between gap-2"
  >
    <!-- Left: Search & Filter -->
    <div class="d-flex align-items-center gap-2">
      <input
        type="text"
        placeholder="Search by title, location or organizer..."
        class="form-control"
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
      />

      <select
        class="form-select"
        [(ngModel)]="selectedFilter"
        (change)="onFilterChange()"
      >
        <option [value]="'all'" [disabled]="filterCounts.all === 0">
          All ({{ filterCounts.all }})
        </option>
        <option [value]="'ended'" [disabled]="filterCounts.ended === 0">
          Ended ({{ filterCounts.ended }})
        </option>
        <option [value]="'full'" [disabled]="filterCounts.full === 0">
          Full ({{ filterCounts.full }})
        </option>
        <option [value]="'notfull'" [disabled]="filterCounts.notfull === 0">
          Not Full ({{ filterCounts.notfull }})
        </option>
      </select>
    </div>

    <!-- Right: Add Event button -->
    <button class="btn btn-success" (click)="toggleAddEventCard()">
      Add Event
    </button>
  </div>

  <!-- Add Event Modal -->
  <div
    class="modal-overlay"
    *ngIf="showAddEventCard"
    (click)="closeAddEvent($event)"
  >
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div
        class="modal-header d-flex justify-content-between align-items-center"
      >
        <h5 class="modal-title">Add New Event</h5>
        <button class="btn-close" (click)="toggleAddEventCard()">
          &times;
        </button>
      </div>

      <div class="modal-body">
        <form>
          <div class="form-group mb-3">
            <label>Title</label>
            <input
              type="text"
              [(ngModel)]="newEvent.title"
              name="title"
              class="form-control"
              placeholder="Event title"
            />
          </div>
          <div class="form-group mb-3">
            <label>Description</label>
            <textarea
              [(ngModel)]="newEvent.description"
              name="description"
              class="form-control"
              placeholder="Event description"
            ></textarea>
          </div>
          <div class="form-group mb-3">
            <label>Location</label>
            <input
              type="text"
              [(ngModel)]="newEvent.location"
              name="location"
              class="form-control"
              placeholder="Event location"
            />
          </div>
          <div class="form-group mb-3">
            <label>Capacity</label>
            <input
              type="number"
              [(ngModel)]="newEvent.capacity"
              name="capacity"
              class="form-control"
              min="1"
            />
          </div>
          <div class="form-group mb-3">
            <label>Start Date & Time</label>
            <input
              type="datetime-local"
              [(ngModel)]="newEvent.startDate"
              name="startDate"
              class="form-control"
            />
          </div>
          <div class="form-group mb-3">
            <label>End Date & Time</label>
            <input
              type="datetime-local"
              [(ngModel)]="newEvent.endDate"
              name="endDate"
              class="form-control"
            />
          </div>
          <div class="mb-2">
  <label>Upload Photos (max 5)</label>
  <input
    type="file"
    (change)="onNewPhotosSelected($event)"
    [disabled]="newEventPhotos.length >= 5"
    multiple
    accept="image/*"
    class="form-control"
  />

  <!-- Preview container -->
  <div class="d-flex flex-wrap mt-2">
    <div
      *ngFor="let photo of newEventPhotos; let i = index"
      class="position-relative m-2"
      style="width: 80px; height: 80px;"
    >
      <img
        [src]="photo.preview"
        class="img-thumbnail"
        style="width: 100%; height: 100%; object-fit: cover;"
      />
      <button
        type="button"
        class="btn-close position-absolute top-0 end-0"
        aria-label="Remove"
        (click)="removeNewPhoto(i)"
      ></button>
    </div>
  </div>
</div>

        </form>
      </div>

      <div class="modal-footer d-flex justify-content-end gap-2">
        <button class="btn btn-secondary" (click)="toggleAddEventCard()">
          Cancel
        </button>
        <button class="btn btn-success" (click)="submitNewEvent()">
          Add Event
        </button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4 mb-4" *ngFor="let event of filteredEvents">
      <div class="event-card shadow-sm p-3 h-100">
        <div class="event-header mb-2">
          <div
            class="event-header mb-2 d-flex justify-content-between align-items-center"
          >
            <h5>
              {{ event.title }}
              <small *ngIf="event.organizerUsername" class="text-muted">
                by {{ event.organizerUsername }}
              </small>
            </h5>
            <small class="text-muted">{{ getTimeAgo(event.createAt) }}</small>
          </div>
          <small class="text-muted">{{ event.location }}</small>
        </div>

        <p class="event-description">{{ event.description }}</p>

        <p class="event-date">
          <strong>Start:</strong> {{ event.startDate | date : "medium" }} <br />
          <strong>End:</strong> {{ event.endDate | date : "medium" }}
        </p>

        <p class="event-capacity">
          <strong>Capacity:</strong> {{ event.capacity }}
        </p>

        <!-- Status: show ONLY one -->
        <!-- Status -->
        <ng-container>
          <p class="text-muted font-italic" *ngIf="isEventEnded(event)">
            Ended
          </p>
          <p
            class="text-danger font-weight-bold"
            *ngIf="!isEventEnded(event) && isEventFull(event)"
          >
            Full
          </p>
          <p
            class="text-success font-weight-bold"
            *ngIf="!isEventEnded(event) && !isEventFull(event)"
          >
            <strong>Members Left:</strong> {{ getRemainingSpots(event) }}
          </p>
          <p
            class="text-success font-weight-bold"
            *ngIf="!isEventEnded(event) && isEventStarted(event)"
          >
            Started
          </p>
        </ng-container>
      <button class="btn btn-primary btn-block mt-2" (click)="openEventModal(event)">
        View Details
      </button>

        <!-- Reserve Button (disabled if full or ended) -->
        <button
          class="btn btn-success btn-block mt-2"
          [disabled]="isEventFull(event) || isEventEnded(event)"
          (click)="reserveSpot(event)"
        >
          Reserve a Spot
        </button>
      </div>
    </div>
  </div>



<!-- Event Details Modal -->
<div class="modal-overlay" *ngIf="showEventModal" (click)="closeEventModal()">
  <div class="modal-card p-4" (click)="$event.stopPropagation()">
    <h5 class="mb-3">{{ selectedEvent.title }}</h5>

    <div class="mb-2">
      <strong>Description:</strong>
      <p>{{ selectedEvent.description }}</p>
    </div>

    <div class="mb-2">
      <strong>Location:</strong>
      <p>{{ selectedEvent.location }}</p>
    </div>

    <div class="mb-2">
      <strong>Photos:</strong>
      <div *ngIf="selectedEvent.photoUrls?.length; else noPhotos">
        <div class="photo-grid mt-2">
          <div class="photo-thumb" *ngFor="let photo of selectedEvent.photoUrls">
            <img [src]="getPhotoUrl(photo)" alt="Event photo" (click)="openPhotoModal(photo)"/>
          </div>
        </div>
      </div>
      <ng-template #noPhotos>
        <p class="text-muted">No photos available for this event.</p>
      </ng-template>
    </div>

    <div class="mb-2">
      <strong>Capacity:</strong> {{ selectedEvent.capacity }}
    </div>

    <div class="mb-2">
      <strong>Start:</strong> {{ selectedEvent.startDate | date: 'medium' }} <br />
      <strong>End:</strong> {{ selectedEvent.endDate | date: 'medium' }}
    </div>

    <div class="mb-2" *ngIf="selectedEvent.reservations?.length">
      <strong>Reservations:</strong> {{ selectedEvent.reservations.length }}
    </div>

    <div class="mt-3 d-flex justify-content-end">
      <button class="btn btn-secondary" (click)="closeEventModal()">Close</button>
    </div>
  </div>
</div>



<!-- Photo Modal -->
<div class="modal-overlay" *ngIf="showPhotoModal" (click)="closePhotoModal()">
  <div class="modal-card photo-modal p-4" (click)="$event.stopPropagation()">
    <button class="btn-close" (click)="closePhotoModal()">Ã—</button>
    <img *ngIf="selectedPhoto" [src]="getPhotoUrl(selectedPhoto)" alt="Event photo" class="photo-large" />
  </div>
</div>



</div>

<div class="own-events-container p-4">
  <h2 class="mb-4">My Organized Events</h2>

  <!-- Error / No Events -->
  <div *ngIf="loading" class="alert alert-info">Loading your events...</div>
  <div *ngIf="!loading && userEvents.length === 0" class="alert alert-warning">
    You haven't organized any events yet.
  </div>

  <div class="row g-4">
    <div class="col-md-6 col-lg-4 mb-3" *ngFor="let event of userEvents">
      <div class="event-card shadow-sm p-3 d-flex flex-column h-100">
        <div
          class="event-header mb-2 d-flex justify-content-between align-items-start"
        >
          <h5>{{ event.title }}</h5>
          <small class="text-muted">{{ getTimeAgo(event.createAt) }}</small>
        </div>

        <p class="text-muted mb-1">
          <strong>Description:</strong> {{ event.description }}
        </p>
        <p class="text-muted mb-1">
          <strong>Location:</strong> {{ event.location }}
        </p>
        <p class="text-muted mb-1">
          <strong>Capacity:</strong> {{ event.capacity }}
        </p>
        <p class="text-muted mb-1">
          <strong>Start:</strong> {{ event.startDate | date : "medium" }}
        </p>
        <p class="text-muted mb-1">
          <strong>End:</strong> {{ event.endDate | date : "medium" }}
        </p>

        <!-- Reservations -->
        <p
          class="text-muted mb-1 d-flex align-items-center justify-content-between"
        >
          <span
            ><strong>Reservations:</strong>
            {{ getActiveReservations(event) }}</span
          >
          <button
            class="btn btn-sm btn-outline-info ms-2"
            (click)="openReservations(event)"
          >
            See Members
          </button>
        </p>

        <!-- Status -->
        <p class="text-muted mb-1">
          <strong>Status:</strong>
          <span
            [ngClass]="{
              'text-success': getEventStatus(event) === 'Not Started Yet',
              'text-warning': getEventStatus(event) === 'Started',
              'text-danger': getEventStatus(event) === 'Full',
              'text-muted font-italic': getEventStatus(event) === 'Ended'
            }"
          >
            {{
              getEventStatus(event) === "Full"
                ? getFullStatus(event)
                : getEventStatus(event)
            }}
          </span>
        </p>

        <div class="mt-auto d-flex justify-content-between gap-2">
          <button
            class="btn btn-outline-primary btn-sm edit-btn"
            (click)="openEditEvent(event)"
            [disabled]="isEventEnded(event)"
          >
            <i class="fas fa-edit me-1"></i> Edit
          </button>
          <button
            class="btn btn-outline-danger btn-sm"
            (click)="deleteEvent(event)"
          >
            <i class="fas fa-trash me-1"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-card p-4" (click)="$event.stopPropagation()">
      <h5>Edit Event</h5>
      <form>
        <!-- Title -->
        <div class="mb-2">
          <label>Title</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="editEvent.title"
            name="title"
          />
        </div>

        <!-- Description -->
        <div class="mb-2">
          <label>Description</label>
          <textarea
            class="form-control"
            [(ngModel)]="editEvent.description"
            name="description"
          ></textarea>
        </div>

        <!-- Location -->
        <div class="mb-2">
          <label>Location</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="editEvent.location"
            name="location"
          />
        </div>

        <!-- Capacity -->
        <div class="mb-2">
          <label>Capacity</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="editEvent.capacity"
            min="5"
            name="capacity"
          />
        </div>

        <!-- Dates -->
        <div class="mb-2">
          <label>Start Date & Time</label>
          <input
            type="datetime-local"
            class="form-control"
            [(ngModel)]="editEvent.startDate"
            name="startDate"
          />
        </div>
        <div class="mb-2">
          <label>End Date & Time</label>
          <input
            type="datetime-local"
            class="form-control"
            [(ngModel)]="editEvent.endDate"
            name="endDate"
          />
        </div>

        <!-- Photos -->
        <div class="mb-2">
          <label>Current Photos</label>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <div
              class="photo-wrapper"
              *ngFor="let photo of editEvent.photoUrls; let i = index"
            >
              <img
                [src]="getPhotoUrl(photo)"
                class="edit-photo-thumb"
                alt="eventphoto"
              />
              <button
                type="button"
                class="remove-photo-btn"
                (click)="removePhoto(i)"
              >
                âœ•
              </button>
            </div>
          </div>
        </div>

        <!-- Upload new photos -->
        <div class="mb-2">
          <label>Add/Replace Photos</label>
          <input
            type="file"
            class="form-control"
            (change)="onPhotoSelected($event)"
            multiple
            accept="image/*"
          />
        </div>

        <!-- Buttons -->
        <div class="mt-3 d-flex justify-content-end gap-2">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeEditModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="submitEditEvent()"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reservations Modal -->
  <div
    class="modal-overlay"
    *ngIf="showReservationsModal"
    (click)="closeReservations()"
  >
    <div class="modal-card p-4" (click)="$event.stopPropagation()">
      <h5>Reserved Members</h5>
      <div *ngIf="selectedReservations.length > 0; else noMembers">
        <ul class="list-group">
          <li *ngFor="let res of selectedReservations" class="list-group-item">
            <div>
            <strong>{{ res.username }}</strong>
            <small>{{ res.email }}</small>
            <span
              ><strong>Date:</strong>
              {{ res.reservationDate | date : "medium" }}</span
            >
            <span><strong>Ticket:</strong> {{ res.ticketnumber }}</span>
            <span><strong>Status:</strong> {{ res.status }}</span>
            </div>
            <div class="reservation-actions">
            <!-- Confirm -->
            <button
              class="btn-action confirm"
              (click)="confirmReservation(res)"
              [disabled]="res.status === 'CONFIRMED' || res.status === 'CANCELLED'"
            >
              <i class="fa-solid fa-circle-check"></i>
            </button>

            <!-- Cancel -->
            <button
              class="btn-action cancel"
              (click)="cancelReservation(res)"
              [disabled]="res.status === 'CANCELLED'"
            >
              <i class="fa-solid fa-circle-xmark"></i>
            </button>
          </div>
          </li>
        </ul>
      </div>
      <ng-template #noMembers>
        <p class="text-muted text-center">No members reserved yet.</p>
      </ng-template>
      <div class="mt-3 d-flex justify-content-end">
        <button class="btn btn-secondary" (click)="closeReservations()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
